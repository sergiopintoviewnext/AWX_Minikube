---

- name: Crear carpeta
  ansible.builtin.file:
    path: "{{ path }}"
    state: directory
    mode: '0755'


- name: Copiar template kustomization.yml
  ansible.builtin.template:
    src: kustomization.yml.j2
    dest: "{{ path }}/kustomization.yml"
    mode: '644'


- name: Ejecutar kustomization.yml
  block:
    - name: Ejecutar kustomization.yml
      ansible.builtin.shell:
        chdir: "{{ path }}"
        cmd: kubectl apply -k .
  rescue:
    - name: Copiar fichero kubernetes en home
      ansible.builtin.copy:
        src: "/home/{{ ansible_user }}/.kube/"
        dest: $HOME/.kube/
        mode: '0755'
        remote_src: true

    - name: Ejecutar kustomization.yml
      ansible.builtin.shell:
        chdir: "{{ path }}"
        cmd: kubectl apply -k .


- name: AÃ±adir linea a fichero kustomization
  ansible.builtin.lineinfile:
    path: "{{ path }}/kustomization.yml"
    insertafter: "- github.com/ansible/awx-operato"
    regexp: "- github.com/ansible/awx-operator"
    line: "  - awx-demo.yml"


- name: Copiar awx-demo.yml
  ansible.builtin.copy:
    src: awx-demo.yml
    dest: "{{ path }}"
    mode: '0644'


- name: Ejecutar kustomization.yml
  ansible.builtin.shell:
    chdir: "{{ path }}"
    cmd: kubectl apply -k .

...